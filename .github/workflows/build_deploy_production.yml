name: Generate RC2D library static (production)

on:
  release:
    types:
      - published
  workflow_dispatch:

permissions:
  contents: write
  discussions: write

env:
  XCODE_VERSION: "26.3.0"

jobs:
  build_librc2d:
    strategy:
      fail-fast: false
      matrix:
        config:
        - { runner: windows-2025,     platform: windows,  arch: x64 }
        - { runner: ubuntu-22.04,     platform: linux,    arch: x64 }
        - { runner: macos-26,         platform: macos,    arch: arm64, sdk: macosx } 
    name: ${{ matrix.config.platform }}-${{ matrix.config.arch }}-${{ matrix.config.sdk }}
    runs-on: ${{ matrix.config.runner }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get dependencies with CMake - All platforms
        run: cmake -P cmake/setup_dependencies.cmake

      - name: Setup Xcode and Setup Command Line Tools - macOS / iOS
        if: matrix.config.platform == 'macos'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Determine SDK Path and set SDKROOT - macOS / iOS
        if: matrix.config.platform == 'macos'
        run: |
          sdk="${{ matrix.config.sdk }}"
          SDKROOT=$(xcrun --sdk "$sdk" --show-sdk-path)
          SDKVERSION=$(xcrun --sdk "$sdk" --show-sdk-version)
          echo "SDKROOT=$SDKROOT" >> $GITHUB_ENV
          echo "Using SDK: $sdk"
          echo "SDK Path: $SDKROOT"
          echo "SDK Version: $SDKVERSION"
        shell: bash

      - name: Install dev dependencies (for SDL3) - Linux (x64)
        if: matrix.config.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get -y install build-essential git make \
          pkg-config cmake ninja-build gnome-desktop-testing libasound2-dev libpulse-dev \
          libaudio-dev libfribidi-dev libjack-dev libsndio-dev libx11-dev libxext-dev \
          libxrandr-dev libxcursor-dev libxfixes-dev libxi-dev libxss-dev libxtst-dev \
          libxkbcommon-dev libdrm-dev libgbm-dev libgl1-mesa-dev libgles2-mesa-dev \
          libegl1-mesa-dev libdbus-1-dev libibus-1.0-dev libudev-dev libthai-dev \
          libpipewire-0.3-dev libwayland-dev libdecor-0-dev liburing-dev

      - name: Build RC2D (scripts) - Linux (x64/arm64)
        if: matrix.config.platform == 'linux'
        shell: bash
        run: |
          set -euxo pipefail
          chmod +x ./build-scripts/generate-project/linux-x64.sh
          ./build-scripts/generate-project/linux-x64.sh

      - name: Build RC2D (scripts) - Windows (x64/arm64)
        if: matrix.config.platform == 'windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          .\build-scripts\generate-project\windows-x64.bat

      - name: Build RC2D (scripts) - macOS (arm64)
        if: matrix.config.platform == 'macos'
        shell: bash
        run: |
          set -euxo pipefail
          chmod +x ./build-scripts/generate-project/macos-arm64.sh
          ./build-scripts/generate-project/macos-arm64.sh
  
# build_deploy_website:
#   needs: build_librc2d
#   runs-on: ubuntu-latest
#   steps:
#
#     - name: Checkout repository
#       uses: actions/checkout@v6
#
#     - name: Get latest release tag
#       id: previoustag
#       uses: WyriHaximus/github-action-get-previous-tag@v2
#
#     - name: Login to DockerHub
#       uses: docker/login-action@v3
#       with:
#         username: ${{ secrets.DOCKER_HUB_USERNAME }}
#         password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
#
#     - name: Build and push Docker image - Production version latest
#       uses: docker/build-push-action@v6
#       with:
#         context: .
#         file: ./docker/production/Dockerfile
#         push: true
#         tags: corentin35/librc2d-website-frontend:latest
#
#     - name: Build and push Docker image - Production version x.x.x
#       uses: docker/build-push-action@v6
#       with:
#         context: .
#         file: ./docker/production/Dockerfile
#         push: true
#         tags: corentin35/librc2d-website-frontend:${{ steps.previoustag.outputs.tag }}
#
#     - name: Replace image tag in deployment.yaml for Kubernetes
#       run: |
#         sed -i 's/\${TAG_VERSION}/'${{ steps.previoustag.outputs.tag }}'/g' k8s/production/deployment.yaml
#
#     - name: Connect to the cluster K3S for deploy
#       uses: actions-hub/kubectl@master
#       env:
#         # TODO: Ã  changer pour le cluster de production
#         KUBE_CONFIG: ${{ secrets.KUBECONFIG_CLUSTER_STAGING_CRZGAMES_BASE64 }}
#       with:
#         args: |
#           apply -f k8s/production/namespace.yaml
#           -f k8s/production/docker-registry-secret.yaml
#           -f k8s/production/deployment.yaml
#           -f k8s/production/ingress.yaml
#           -f k8s/production/service.yaml